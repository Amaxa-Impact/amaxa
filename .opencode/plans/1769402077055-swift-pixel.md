# Sprint 6: Template System Implementation Plan

## Overview

Templates are blueprints for scaffolding projects with pre-defined tasks, positions, and dependencies.

**Two template scopes:**

1. **Global templates** - Site admin managed, available to all workspaces
2. **Workspace templates** - Workspace admin managed, workspace-specific

**Key features:**

- Visual template editor (React Flow)
- "Save as Template" from existing projects
- "Copy to Workspace" for global templates (allows workspace admins to customize)
- Template selection during project creation

---

## Schema Changes

**File:** `packages/backend/convex/schema.ts`

Add two tables:

```typescript
projectTemplates: defineTable({
  name: v.string(),
  description: v.optional(v.string()),
  createdBy: v.string(),  // userId
  isPublic: v.boolean(),  // visible when creating projects
  // null = global template, Id = workspace-specific
  workspaceId: v.optional(v.id("workspaces")),
})
  .index("by_createdBy", ["createdBy"])
  .index("by_isPublic", ["isPublic"])
  .index("by_workspaceId", ["workspaceId"]),

templateTasks: defineTable({
  templateId: v.id("projectTemplates"),
  label: v.string(),
  description: v.optional(v.string()),
  status: v.union(v.literal("todo"), v.literal("in_progress"), v.literal("completed"), v.literal("blocked")),
  priority: v.union(v.literal("low"), v.literal("medium"), v.literal("high")),
  position: v.object({ x: v.number(), y: v.number() }),
  dependencies: v.array(v.id("templateTasks")),  // edges derived from this
})
  .index("by_templateId", ["templateId"]),
```

---

## Backend Files

### `packages/backend/convex/projectTemplates.ts` (new)

| Function            | Type     | Access                        | Purpose                                    |
| ------------------- | -------- | ----------------------------- | ------------------------------------------ |
| `list`              | query    | public                        | List templates (global + user's workspace) |
| `listForWorkspace`  | query    | workspace member              | List workspace templates                   |
| `listGlobal`        | query    | authenticated                 | List global templates only                 |
| `get`               | query    | member/admin                  | Get template with tasks                    |
| `create`            | mutation | site admin OR workspace admin | Create template                            |
| `update`            | mutation | creator OR site admin         | Update template metadata                   |
| `remove`            | mutation | creator OR site admin         | Delete template + tasks                    |
| `duplicate`         | mutation | authenticated                 | Copy template (to workspace)               |
| `createFromProject` | mutation | project coach                 | Save project as template                   |

**Permission logic:**

- Global templates (`workspaceId: null`): site admin only
- Workspace templates: workspace admin can CRUD
- Anyone can duplicate a global template to their workspace

### `packages/backend/convex/templateTasks.ts` (new)

| Function               | Type     | Access          | Purpose                          |
| ---------------------- | -------- | --------------- | -------------------------------- |
| `listForTemplate`      | query    | template access | List all tasks for template      |
| `create`               | mutation | template editor | Add task                         |
| `update`               | mutation | template editor | Update task fields               |
| `updatePosition`       | mutation | template editor | Move task (drag)                 |
| `batchUpdatePositions` | mutation | template editor | Move multiple tasks              |
| `remove`               | mutation | template editor | Delete task + clean dependencies |
| `addDependency`        | mutation | template editor | Create edge (source→target)      |
| `removeDependency`     | mutation | template editor | Remove edge                      |

### `packages/backend/convex/projects.ts` (modify)

Add:

| Function | Type | Access | Purpose |
|----------|------|--------|---------|
| `createFromTemplate` | mutation | workspace admin | Scaffold project from template |

**Data flow for `createFromTemplate`:**

1. Verify template exists & is accessible (global OR user's workspace)
2. Create project
3. For each templateTask → create `tasks` + `taskNodes` record
4. Map templateTask IDs → new task IDs
5. For each dependency → create `edges` record using mapped IDs

---

## Frontend Files

### Templates List Page (Internal/Admin)

**`apps/platform/src/app/(internal)/(authed)/templates/`**

- `page.tsx` - Server component, preload global templates
- `client.tsx` - List page with table + create dialog
- `loading.tsx` - Loading skeleton
- `layout.tsx` - TopNavbar wrapper

### Template Editor Page

**`apps/platform/src/app/(internal)/(authed)/templates/[templateId]/`**

- `page.tsx` - Server component, preload template + tasks
- `client.tsx` - React Flow editor
- `loading.tsx` - Loading skeleton

### Workspace Templates Page

**`apps/platform/src/app/[workspace]/admin/templates/`**

- `page.tsx` - Server component
- `client.tsx` - List workspace templates + option to copy global templates

### Workspace Template Editor

**`apps/platform/src/app/[workspace]/admin/templates/[templateId]/`**

- `page.tsx` - Server component
- `client.tsx` - React Flow editor (same component, workspace context)

### Shared Components

**`apps/platform/src/components/templates/`**

- `template-task-node.tsx` - React Flow node component
- `template-editor.tsx` - Shared React Flow editor wrapper
- `create-template-dialog.tsx` - Create from scratch
- `save-as-template-dialog.tsx` - Create from project
- `template-selector.tsx` - Dropdown for project creation

### Update Project Creation Dialog

**`apps/platform/src/app/[workspace]/(app)/_components/projects-table.tsx`**

Add template selector to `CreateProjectDialog`:

- Show global templates (available to all)
- Show workspace templates (workspace-specific)
- Option: "Blank project" (no template)

---

## Implementation Order

### Phase 1: Schema + Core Backend

1. Add schema (2 tables + indexes)
2. Create `projectTemplates.ts` with CRUD (site admin only first)
3. Create `templateTasks.ts` with CRUD
4. Add tests

### Phase 2: Template Editor UI

1. Templates list page `(internal)/templates`
2. Create template dialog
3. Template editor page with React Flow
4. Template task node component

### Phase 3: Project Integration

1. `createFromTemplate` mutation in projects.ts
2. Update project creation dialog with template selector
3. "Save as Template" from project settings

### Phase 4: Workspace Templates

1. Add workspace scope support to backend
2. Workspace templates page
3. "Copy to Workspace" for global templates

---

## Key Files to Modify/Create

**Backend (packages/backend/convex/):**

- `schema.ts` - Add 2 tables
- `projectTemplates.ts` - NEW
- `templateTasks.ts` - NEW
- `projects.ts` - Add `createFromTemplate`

**Frontend (apps/platform/src/):**

- `app/(internal)/(authed)/templates/` - NEW (4 files)
- `app/(internal)/(authed)/templates/[templateId]/` - NEW (3 files)
- `app/[workspace]/admin/templates/` - UPDATE existing placeholder
- `app/[workspace]/admin/templates/[templateId]/` - NEW (3 files)
- `components/templates/` - NEW (5 files)
- `app/[workspace]/(app)/_components/projects-table.tsx` - UPDATE

---

## Verification

1. **Backend tests**: Run `pnpm test --filter="@amaxa/backend"` - template CRUD + createFromProject/createFromTemplate
2. **Permission test**: Non-admin cannot edit global template, can copy to workspace
3. **E2E**: Full flow from template creation to project scaffolding
